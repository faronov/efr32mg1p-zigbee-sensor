name: Build EFR32MG1P Zigbee Sensor

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git git-lfs make python3 python3-pip unzip wget libncurses6

    - name: Install GNU Arm Embedded Toolchain
      run: |
        # Download official GNU Arm Embedded Toolchain
        ARM_TOOLCHAIN_VERSION="10.3-2021.10"
        ARM_TOOLCHAIN_URL="https://developer.arm.com/-/media/Files/downloads/gnu-rm/10.3-2021.10/gcc-arm-none-eabi-10.3-2021.10-x86_64-linux.tar.bz2"

        echo "Downloading GNU Arm toolchain..."
        wget -q "$ARM_TOOLCHAIN_URL" -O gcc-arm-none-eabi.tar.bz2

        echo "Extracting toolchain..."
        tar -xjf gcc-arm-none-eabi.tar.bz2 -C /opt/

        # Add to PATH
        echo "/opt/gcc-arm-none-eabi-${ARM_TOOLCHAIN_VERSION}/bin" >> $GITHUB_PATH

        # Verify installation
        /opt/gcc-arm-none-eabi-${ARM_TOOLCHAIN_VERSION}/bin/arm-none-eabi-gcc --version

    - name: Install Silicon Labs SLC CLI
      run: |
        # Download SLC CLI for Linux
        SLC_URL="https://www.silabs.com/documents/public/software/slc_cli_linux.zip"

        echo "Downloading SLC CLI..."
        wget -q "$SLC_URL" -O slc_cli.zip || {
          echo "Warning: Direct download failed"
        }

        if [ -f slc_cli.zip ]; then
          echo "Extracting SLC CLI..."
          mkdir -p /opt/slc_cli
          unzip -q slc_cli.zip -d /opt/slc_cli

          # Find the slc executable (it might be in a subdirectory)
          SLC_EXEC=$(find /opt/slc_cli -name "slc" -o -name "slc-cli" | head -n 1)

          if [ -n "$SLC_EXEC" ]; then
            echo "Found SLC at: $SLC_EXEC"
            chmod +x "$SLC_EXEC"
            SLC_DIR=$(dirname "$SLC_EXEC")

            # Create symlink if binary is named slc-cli
            if [[ "$SLC_EXEC" == *"slc-cli" ]]; then
              sudo ln -sf "$SLC_EXEC" "$SLC_DIR/slc"
              echo "Created symlink: slc -> slc-cli"
            fi

            echo "$SLC_DIR" >> $GITHUB_PATH
            echo "SLC CLI installed successfully"
          else
            echo "Warning: Could not find slc executable in extracted files"
            ls -la /opt/slc_cli/
          fi
        else
          echo "Warning: Could not download SLC CLI"
        fi

    - name: Verify SLC CLI installation
      run: |
        echo "Current PATH: $PATH"
        echo "Checking for slc..."

        # Check if slc is available
        if command -v slc &> /dev/null; then
          echo "✓ SLC CLI found: $(which slc)"
          slc --version || echo "SLC version check skipped"
        elif command -v slc-cli &> /dev/null; then
          echo "✓ slc-cli found: $(which slc-cli)"
          slc-cli --version || echo "SLC version check skipped"
        else
          echo "Warning: SLC CLI not found in PATH"
          echo "Checking /opt/slc_cli..."
          find /opt/slc_cli -name "slc*" -type f 2>/dev/null || echo "No slc files found"
        fi

    - name: Clone Gecko SDK 4.5
      run: |
        echo "Cloning Gecko SDK 4.5..."
        git clone --depth 1 --branch gsdk_4.5 https://github.com/SiliconLabs/gecko_sdk.git

        echo "GSDK cloned successfully"
        echo "Available Zigbee sample projects:"
        find gecko_sdk/protocol/zigbee -name "*.slcp" 2>/dev/null | grep -i "sensor\|enddevice\|end_device" | head -10 || echo "No samples found"

    - name: Build firmware
      env:
        GSDK_DIR: ${{ github.workspace }}/gecko_sdk
        BOARD: brd4151a
      run: |
        echo "Starting build process..."
        echo "GSDK_DIR: $GSDK_DIR"
        echo "PATH: $PATH"

        # Ensure slc is in PATH
        if ! command -v slc &> /dev/null; then
          echo "slc not found, checking for slc-cli..."
          if command -v slc-cli &> /dev/null; then
            echo "Using slc-cli, creating alias..."
            alias slc='slc-cli'
          else
            echo "Manually adding SLC to PATH..."
            export PATH="/opt/slc_cli/slc_cli/bin:$PATH"
          fi
        fi

        echo "SLC command: $(which slc 2>/dev/null || which slc-cli 2>/dev/null || echo 'not found')"

        # Find a suitable Zigbee end device sample (exclude GPD, host, NCP, RCP)
        SAMPLE_SLCP=$(find gecko_sdk/protocol/zigbee -name "*.slcp" 2>/dev/null | \
          grep -E "z3.*end.*device|sleepy.*end|minimal" | \
          grep -v "host\|ncp\|rcp\|gpd" | \
          head -n 1)

        if [ -z "$SAMPLE_SLCP" ]; then
          echo "Error: Could not find suitable Zigbee sample"
          echo "Available samples:"
          find gecko_sdk/protocol/zigbee -name "*.slcp" 2>/dev/null | head -20
          exit 1
        fi

        echo "Using sample: $SAMPLE_SLCP"
        export SAMPLE_SLCP

        # Run build script
        bash tools/build.sh

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: firmware-build-${{ github.sha }}
        path: |
          firmware/**/*.elf
          firmware/**/*.hex
          firmware/**/*.bin
          firmware/**/*.s37
          firmware/**/*.map
        retention-days: 30

    - name: Upload build log on failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-log-failure-${{ github.sha }}
        path: |
          firmware/*.log
          firmware/**/*.log
        retention-days: 14

    - name: Build summary
      if: success()
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # List all build outputs
        if [ -d firmware ]; then
          for ext in elf hex bin s37; do
            FILES=$(find firmware -name "*.${ext}" 2>/dev/null || true)
            if [ -n "$FILES" ]; then
              echo "#### ${ext^^} Files:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$FILES" | while read -r file; do
                SIZE=$(ls -lh "$file" | awk '{print $5}')
                echo "$(basename $file): $SIZE" >> $GITHUB_STEP_SUMMARY
              done
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done
        fi

        echo "✅ Build completed successfully!" >> $GITHUB_STEP_SUMMARY
